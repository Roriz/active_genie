#!/usr/bin/bash

touch test_output.tmp
rake "test[test/e2e/$1]" | tee >(cat) > test_output.tmp
output=$(cat test_output.tmp)
rm test_output.tmp
echo ""
result_line=$(echo "$output" | grep -E '[0-9]+ runs, [0-9]+ assertions, [0-9]+ failures, [0-9]+ errors, [0-9]+ skips' | tail -1)
if [ -n "$result_line" ]; then
  runs=$(echo $result_line | grep -oE '[0-9]+ runs' | grep -oE '[0-9]+')
  failures=$(echo $result_line | grep -oE '[0-9]+ failures' | grep -oE '[0-9]+')
  successes=$((runs - failures))
  precision=$(awk "BEGIN {printf \"%.2f\", $successes/$runs}")
  duration=$(echo "$output" | grep -oE 'Finished in [0-9]+\.[0-9]+s' | grep -oE '[0-9]+\.[0-9]+')
  echo "| Battle | $PROVIDER | $MODEL | $runs/$successes/$failures | $precision | $duration |" >> benchmark.md
fi