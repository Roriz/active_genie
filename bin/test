#!/usr/bin/bash

MODULE="$1"
if [ "$MODULE" = "all" ]; then
  MODULE=""
fi

touch test_output.tmp
rake "test[test/e2e/$MODULE]" | tee >(cat) > test_output.tmp
output=$(cat test_output.tmp)
rm test_output.tmp
echo ""
result_line=$(echo "$output" | grep -E '[0-9]+ runs, [0-9]+ assertions, [0-9]+ failures, [0-9]+ errors, [0-9]+ skips' | tail -1)
if [ -n "$result_line" ]; then
  runs=$(echo $result_line | grep -oE '[0-9]+ runs' | grep -oE '[0-9]+')
  failures=$(echo $result_line | grep -oE '[0-9]+ failures' | grep -oE '[0-9]+')
  successes=$((runs - failures))
  precision=$(($successes*100/$runs))
  duration=$(echo "$output" | grep -oE 'Finished in [0-9]+\.[0-9]+s' | grep -oE '[0-9]+\.[0-9]+')
fi

all_llm_usage=$(cat logs/active_genie.log | grep "llm_usage" | jq -r '.total_tokens')
requests=$(echo "$all_llm_usage" | wc -l)
for llm_stat in $all_llm_usage; do
  total_tokens=$((total_tokens + llm_stat))
done

avg_duration=$(awk "BEGIN {printf \"%.2f\", $duration/$runs}")

touch benchmark/latest.csv
touch benchmark/latest.md
echo "$MODULE,$PROVIDER,$MODEL,$successes/$failures ($runs),$precision,$duration,$requests,$total_tokens,$avg_duration" >> benchmark/latest.csv

echo "| ActiveGenie::Module | Provider | Model | Tests (Total/Success/Fails) | Precision | Duration (s) | Requests | Tokens | Avg. Duration (s) |" >> benchmark/latest.md
echo "|--- |--- |--- |--- |--- |--- |--- |--- |--- |" >> benchmark/latest.md
echo "| $MODULE | $PROVIDER | $MODEL | $successes/$failures ($runs) | $precision | $duration | $requests | $total_tokens | $avg_duration |" >> benchmark/latest.md

cat benchmark/latest.md
